故障处理基本原则
用户必须遵循故障处理原则和注意事项进行定位和排除故障。
故障处理原则
请遵循以下原则对故障进行分析、定位和处理：
以尽快恢复系统为原则。
定位故障时，应及时收集故障数据信息，并尽量将收集到的故障数据信息保存在移动存储介质中或网络中其他计算机中。
在确定故障处理的方案时，应先评估影响，优先保证业务的正常传送。
第三方的硬件故障，可查看第三方的相关资料或拨打第三方公司的服务电话。
如果无法定位出故障点或无法按手册解决故障，请联系华为技术支持工程师，最大程度减少业务中断时间。
故障处理注意事项
应先分析故障现象，定位原因后再进行处理。在原因不明的情况下应避免盲目操作，导致问题扩大化。
在处理故障前，需要保留好故障现场的所有记录，不能随意删除数据或日志。
在处理故障时，为了确保客户网络的安全和隐私，如果需要收集相关故障日志，请事先得到客户的同意。
在进行任何修改前，应先通过脚本导出、手工备份等方式备份数据。
在系统恢复后，必须对运行情况进行观察，确认故障已经排除并及时填写相关的处理报告。
相关操作必须得到客户的授权，禁止进行超出客户审批范围的任何操作。在完成服务后，必须在客户的监督下对所涉及的个人数据进行安全删除，针对敏感市场未经客户授权禁止传出客户网络。
故障处理流程
介绍故障处理的总体流程。
如果系统运行异常，可参照故障处理流程、遵照故障处理原则和注意事项来定位故障，并修复系统，如果无法修复请联系华为技术支持工程师。
故障处理流程如图2-1所示。
故障处理流程
一般情况下，故障处理分为故障定位、信息收集和故障排除三个阶段。
收集故障信息
遇到系统故障时，需要及时收集相关信息，以便定位问题及处理。
为了确保客户网络的安全，在收集故障信息之前，请首先获得客户的书面授权。同时，需遵循所适用国家的法律或公司用户隐私政策采取足够的措施，以确保用户数据受到充分的保护。
请在发现问题时立即收集相关日志，需要收集所有节点的相关日志，系统以节点的IP地址命名各日志压缩包名称。收集日志后请联系华为技术支持工程师定位故障原因。
系统发生故障时，参考表3-1收集故障信息。
故障信息项
以下为常见的故障场景：
业务面应用操作异常，需要收集业务面日志。
升级，补丁升级出错，需要收集管理面日志以及应用日志。
可靠性等问题需要收集管理面日志。
Web界面操作报异常，或者资源找不到，数据库连接失败等问题，需要收集业务面日志以及管理面日志。
功能响应慢问题，需要收集业务面日志，接入问题日志。
安装完成后，或者运行一段时间后，31943连接不上或登录不上，需要收集接入问题日志。
应用界面，请求无响应，需要获取业务面日志，接入问题日志。
界面登录及显示故障
4.1  管理面无法访问
4.2  tmp目录的空间满导致管理面 Web页面显示空白
4.3  Firefox浏览器访问Web界面时显示异常
4.4  系统管理员无法成功登录运维面
4.5  非系统管理员无法成功登录运维面
4.6  上传文件时，长时间停留在正在导入状态
管理面无法访问
现象描述
使用浏览器访问管理面时，Web登录界面显示异常或者无法登录。
对于异地容灾场景，本节以在主用站点上操作为例，若备用站点管理面无法访问，请参考主用站点上的操作在备用站点上执行。
可能原因
管理节点被下电或者网络异常。
管理面数据库状态异常。
管理面服务异常。
处理步骤
该故障排查方法比较复杂，此处只介绍初步的排查方法，如果仍不能解决，请联系华为技术支持工程师处理。
排查管理节点是否被下电。
请联系管理员检查节点下电情况并上电。
对于异地容灾场景，请联系管理员检查主用站点和备用站点管理节点的下电情况，若两站点的管理节点都被下电，则联系管理员上电，然后执行以下操作，否则请执行步骤2。
登录管理面，具体操作请参见15.1 登录管理面。
在管理面主菜单中选择“高可用 > 异地高可用系统 > 管理异地容灾系统”。
在待同步数据的产品所在行“操作”列中，单击，选择产品的数据同步方向。
若主站点和备站点的状态非主用和备用，则需要选择产品的数据同步方向，异地容灾系统会根据用户选择方向进行全量数据同步，例如选择从A站点产品向B站点产品同步数据，则B站点的产品数据会被覆盖，并且B站点管理面的用户管理数据将在第二天的00:00:00被A站点管理面的用户管理数据覆盖。建议以含有最新数据的产品为主用站点产品，向对端站点产品同步。
若主站点和备站点的状态为主用和备用，无需选择产品的数据同步方向，系统会自动从主用站点向备用站点同步数据。备用站点管理面的用户管理数据，将在第二天的00:00:00被主用站点管理面的用户管理数据覆盖。
按照界面上的指引完成相关操作。
检查操作结果。如果操作结果与预期不符，请联系华为技术支持工程师。
在管理面主菜单中选择“高可用 > 异地高可用系统 > 管理异地容灾系统”。
查看主用站点和备用站点间的心跳状态为。
查看所有产品的“数据同步状态”为“已同步”或者“同步中”。如果“数据同步状态”显示为“延迟”，表示主用站点和备用站点有较多的数据正在同步，请等待数据同步完成后再检查状态。
主用站点的运维面能正常登录，具体操作请参见15.2 登录运维面。
在运维面主菜单中选择“业务监控 > 告警监控 > 当前告警”。检查告警界面显示正常。
排查管理面网络是否故障。
请联系管理员检查网络状态并修改故障。
排查管理面数据库实例是否异常。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，请先登录Management0节点执行以下操作，然后登录Management1节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，切换至ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令，查看管理面数据库运行状态。
> cd <安装目录>/manager/apps/DBAgent/bin
> bash dbsvc_adm -cmd query-db-instance
系统提示如下类似回显信息：
DBInstanceId            ClassId  InstNumber        Tenant   AzName         IP           Port  State  ... 
backuprdb-0-999         single   backuprdb-0-999   manager  cn-global-1-a  10.7.162.90  26522  --     ... 
cloudsopdbsvr-1-0@2-0   primary  cloudsopdbsvr-1-0 SOP      service        10.7.162.93  32080  Up     ... 
cloudsopdbsvr-1-0@2-0   primary  cloudsopdbsvr-2-0 SOP      service        10.7.162.92  32080  Up     ... 
dbmgr_rdb-0-999         single   dbmgr_rdb-0-999   manager  cn-global-1-a  10.7.162.90  32091  --     ... 
...
“State”为“Up”或者“--”时，说明该数据库实例运行正常，执行步骤4。
“State”为“Down”时，说明该数据库实例停止运行，执行以下操作。
如果管理面或者产品的部署模式是集群模式时，在PuTTY工具中以ossadm用户执行以下命令，禁止主备数据库实例在180分钟内发生倒换，否则请跳过本步骤。
> cd <安装目录>/manager/agent/bin
> bash dbha_switch_tool.sh -cmd set-ignore-nodes -nodes all -expire 180
如果回显信息中未显示“Successful”，则表示执行失败，请联系华为技术支持工程师。
执行以下命令，启动管理面数据库。
> source <安装目录>/manager/bin/engr_profile.sh
> ipmc_adm -cmd startdc -tenant manager
系统提示如下类似回显信息，所有进程都提示“success”，则说明管理面数据库启动成功。否则请联系华为技术支持工程师。
============================ Starting data container processes... 
Starting redis process woadapterrdb-1-14 ... success 
... 
Starting redis process serviceinspectionrdb-1-3 ... success 
Starting redis process privilegerdb-1-28 ... success 
============================ Starting data container processes is complete.
如果管理面或者产品的部署模式是集群模式时，执行以下命令，恢复主备数据库实例的倒换，否则请跳过本步骤。
> cd <安装目录>/manager/agent/bin
> bash dbha_switch_tool.sh -cmd del-ignore-nodes
如果回显信息中未显示“Successful”，则表示执行失败，请联系华为技术支持工程师。
排查管理面服务是否异常。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，请先登录Management0节点执行以下操作，然后登录Management1节点执行以下操作。
执行以下命令，切换至ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令，查看管理面运行状态。
> source <安装目录>/manager/bin/engr_profile.sh
> ipmc_adm -cmd statusapp -tenant manager
系统提示如下类似回显信息：
Process Name               Process Type           App Name                 Tenant Name  Process Mode  IP               PID     Status   
backupwebsite-0-0          backupwebsite          BackupWebsite            manager      cluster       10.93.95.239     341187  RUNNING  
unideploywebsite-0-0       unideploywebsite       UniDeployWebsite         manager      cluster       10.93.95.239     341202  RUNNING  
mcfebservice-0-0           mcfebservice           MCFEBService             manager      cluster       10.93.95.239     341553  RUNNING  
... 
 
[All Processes: 16] [Running: 16] [Not Running: 0]
“Not Running”为“0”时，说明所有进程都运行正常。
“Not Running”为非“0”时，说明存在停止运行或者故障的进程，执行步骤4.4。
执行以下命令，启动管理面服务。
> ipmc_adm -cmd startapp -tenant manager
系统提示如下类似回显信息，所有进程都提示“success”，则说明管理面服务启动成功，否则请联系华为技术支持工程师。
Starting process backupwebsite-0-0 ... success  
Starting process smapp-0-0 ... success  
Starting process cron-0-0 ... success  
...
----结束
tmp目录的空间满导致管理面 Web页面显示空白
现象描述
登录管理面的Web页面后，页面显示空白。
可能原因
管理面页面的部分请求，会将一些缓存文件写入缓存目录，当缓存目录磁盘被占满时，缓存目录无法写入，造成这些请求资源文件无法返回管理面，页面显示空白。
处理步骤
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，请分别登录所有管理节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，查看节点上磁盘空间情况。
> df -h
系统回显如下类似信息：
Filesystem                  Size  Used Avail Use% Mounted on 
/dev/sda3                    17G  5.0G   11G  32% / 
 
... 
 
/dev/sda6                   5.0G  208M  4.8G   5% /tmp 
/dev/mapper/oss_vg-opt_vol  290G  290G    0G 100% /opt 
tmpfs                       3.2G     0  3.2G   0% /run/user/3001 
tmpfs                       3.2G     0  3.2G   0% /run/user/0
在“Mounted on”列中查看“/opt”目录所对应的“Use%”是否达到100%。
若达到100%，是由于“<安装目录>/tmp”目录空间已满，请清理该目录的空间或者联系华为技术支持工程师。
若未达到100%，是由于其他原因造成，请联系华为技术支持工程师。
清理目录空间后重新登录管理面，具体操作请参见15.1 登录管理面。
若页面显示正常，操作结束。
若页面仍显示空白，请联系华为技术支持工程师。
----结束
Firefox浏览器访问Web界面时显示异常
现象描述
使用Firefox浏览器访问Web界面时，滚动鼠标时界面出现黑色暗影情况，设置Firefox浏览器的参数后可解决这些问题。不同版本的浏览器界面可能有所差异，以下涉及浏览器的内容仅用作举例 ，在其他版本的浏览器上进行相关操作与此类似，请以实际情况为准。
可能原因
浏览器参数设置造成显示异常。
处理步骤
单击Firefox浏览器右上角的。
单击“选项”。
在左侧选择“常规”，在右侧的“性能”区域中取消勾选“使用推荐的性能设置”，然后取消勾选“自动启用硬件加速”。
重启Firefox浏览器。
----结束
系统管理员无法成功登录运维面
现象描述及可能原因
根据表4-1中系统管理员登录运维面时的现象描述，查询故障的可能原因。
故障现象与原因关系表
如果以上措施无法解决故障，请联系华为技术支持工程师处理。
处理步骤
提示禁止当前用户从本机登录。
单网卡用户登录
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击系统管理员的用户名，在“访问控制”页签查看系统管理员所绑定的登录IP地址控制策略。
使用系统管理员绑定的IP地址，以系统管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击系统管理员的用户名，在“访问控制”页签查看系统管理员所绑定的登录IP地址控制策略。
单击“修改”，查看是否存在符合需求的IP地址控制策略。
存在，直接选择对应的IP地址控制策略，单击“确定”。
不存在，单击“创建”，创建新的IP地址控制策略，单击“确定”。
多网卡用户登录
重复登录时，系统管理员是否可以登录。
可以登录，执行g。
无法登录，执行b。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击系统管理员的用户名，在“访问控制”页签查看系统管理员所绑定的登录IP地址控制策略。
使用系统管理员绑定的IP地址，以系统管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击系统管理员的用户名，在“访问控制”页签查看系统管理员所绑定的登录IP地址控制策略。
单击“修改”，将所有网卡IP地址都添加到系统管理员绑定的登录IP地址控制策略中。
建议与总结
如果使用命令工具停用系统管理员，可能导致系统管理员无法登录，请谨慎使用。
如果系统管理员给自己设置了登录IP地址控制策略，可能导致不在IP地址范围内的系统管理员被强制退出，无法登录，请谨慎设置。
建议设置合适的系统管理员在线会话数限制策略。
如果给系统管理员设置达到最大在线会话数后限制登录，当登录的系统管理员数量达到上限时，可能导致系统管理员无法登录，请谨慎设置。
如果已经设置的系统管理员在线会话数限制策略不满足用户使用，建议在用户管理中修改。
修改系统管理员的最大在线会话数。
修改系统管理员达到最大在线会话数后的登录方式为“注销会话”。
如果已经设置的系统管理员在线会话数限制策略无需修改，可在用户管理中强制注销系统管理员的在线会话。
当需要对系统进行维护操作时，可以将登录模式设置为单用户模式。切换到单用户模式后，只允许一个系统管理员通过一个客户端登录，其他所有的在线用户将被强制退出。为避免影响其他人正常使用系统，在单用户模式下完成维护操作后，请及时切换为多用户模式。
如果已经设置的IP锁定策略不满足用户使用，建议在帐号策略中修改。
非系统管理员无法成功登录运维面
现象描述及可能原因
根据表4-2中用户登录运维面时的现象描述，查询故障的可能原因。
故障现象与原因关系表
如果以上措施无法解决故障，请联系系统管理员处理。
如果是安全管理员无法登录，需要以系统管理员登录运维面，执行以上措施。
处理步骤
提示用户被停用。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中，单击目标用户“操作”列的“启用”，启用该用户。
单击目标用户名，在“基本信息”页签下，单击“修改”。
展开“高级设置”，设置合适的用户策略，排除故障。
修改“帐户可登录次数”。
修改“帐户有效期”。
修改“启用未登录用户策略”。
单击“确定”。
提示在线会话数达到上限。
等待该用户的其他会话注销。
修改该用户的最大在线会话数策略。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。并在用户列表中单击目标用户名。
在“基本信息”页签下展开高级设置，单击“修改”。
执行如下操作，排除故障。
修改“最大在线会话数”。
修改“达到最大在线会话数后的登录方式”为“注销会话”。
单击“确定”。
强制注销该用户的在线用户会话。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“在线用户”。
在列表中，选择需要注销的目标用户会话，单击“操作”列的“强制注销”。
提示禁止当前用户在该时间段内登录。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击目标用户名，在“访问控制”页签查看该用户所绑定的登录时间控制策略。
单击“修改”，查看是否存在符合需求的时间策略。
存在，直接选择对应的时间策略，单击“确定”。
不存在，单击“创建”，创建新的时间策略，单击“确定”。
提示禁止当前用户从本机登录。
单网卡用户登录。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中单击目标用户名，在“访问控制”页签查看该用户所绑定的登录IP地址控制策略。
单击“修改”，查看是否存在符合需求的IP地址控制策略。
存在，直接选择对应的IP地址控制策略，单击“确定”。
不存在，单击“创建”，创建新的IP地址控制策略，单击“确定”。
多网卡用户登录，将所有网卡IP地址都添加到该用户绑定的登录IP地址控制策略中，执行i-v。
提示用户被锁定，还需XXX分钟自动解锁。
等待界面提示的锁定时间之后自动解锁。
手动解锁该用户。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
在用户列表中，单击目标用户“操作”列的“ > 解锁”。
提示密码已过期，修改密码时提示用户不允许修改密码。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。
执行如下操作，排除故障。
在用户列表中，单击目标用户“操作”列的“重置密码”，输入新密码。
在用户列表中单击目标用户名，在“基本信息”页签下展开高级设置，单击“修改”。
关闭“用户不能更改密码”策略。
修改“启用密码修改时间策略”。
单击“确定”。
提示请输入正确的用户名和密码。
检查该用户是否存在。
以安全管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 用户管理”。
在左侧导航树中选择“用户”。在用户列表中，查看目标用户是否存在。
存在，执行b。
不存在，创建用户或使用已存在的用户登录运维面。
检查系统是否已开启远端认证且不支持本地用户认证。
以系统管理员登录运维面。
在运维面主菜单中选择“系统 > 安全管理 > 认证管理”。
在左侧导航树中选择“远端认证配置”，查看是否已开启了LDAP认证或RADIUS认证且不支持本地用户认证。
已开启远端认证且不支持本地用户认证，执行c。
已开启远端认证且支持本地用户认证，执行d。
未开启，执行d。
如果开启了LDAP认证，查看“远端认证配置”时默认在“LDAP认证”页面。
如果开启了RADIUS认证，查看“远端认证配置”时默认在“RADIUS认证”页面。
根据使用场景确认是否继续使用远端认证。
是，开启“支持本地用户认证”，单击“应用”。
如果开启的是LDAP认证且“用户认证方式”为“固定用户”时，选中“支持本地用户认证”后，“管理员密码”会被清空，需重新输入。
如果开启的是RADIUS认证，选中“支持本地用户认证”后，“共享密钥”会被清空，需重新输入。
否，切换到“本地认证”，单击“应用”。
如果用户依然无法登录，在用户列表中，单击目标用户“操作”列的“重置密码”，重置该用户的密码。
建议与总结
如果已设置的“用户策略”不满足用户使用，建议可以在“用户策略”页面修改以下策略解决：
在“帐号策略”页面修改“启用帐号停用策略”、“启用帐号锁定策略”和“启用IP锁定策略”。
在“密码策略”页面修改“密码过期强制修改策略”。
如果已经设置的未登录用户策略不满足用户使用，建议在帐号策略中修改。满足用户未登录用户策略的用户被删除后系统无法恢复，请谨慎设置。
上传文件时，长时间停留在正在导入状态
现象描述
使用Firefox浏览器，执行文件上传时，例如：批量导入用户、批量创建角色、上传密码字典等，界面长时间停留在正在导入状态，最终上传失败。
可能原因
使用Firefox浏览器，执行文件上传过程中，对已在界面上选择的文件进行修改而使文件发生变化，导致浏览器无法正确获取已选择文件的信息。
处理步骤
在文件上传界面，删除已选择的文件，重新选择文件上传。
建议与总结
由于Firefox浏览器的原因，在使用Firefox浏览器执行文件上传时，不能对已选择的上传文件进行修改，否则将导致上传文件失败。
建议使用其他浏览器避免此问题。
节点故障
根据节点的部署模式，参见表5-1执行相关操作。
判断管理节点和产品节点是否为同一个节点，具体操作请参见15.12 查看节点的部署模式。
场景分类
5.1  管理节点故障
5.2  产品节点故障
5.3  共部署节点故障
5.4  多个管理节点同时故障（GaussDB）
5.5  浮动IP地址倒换生效时间超出预期
5.6  部分产品节点下电导致kafka服务异常
管理节点故障
现象描述
使用浏览器登录管理面或使用PuTTY工具登录管理节点时，无法登录或无响应。
可能原因
网络故障。
该节点被下电。
操作系统损坏。
管理面应用软件或数据库损坏。
处理步骤
依次执行表5-2中的检查项及其检查方法，按照对应的故障排除方法修复故障节点。
导致管理节点故障的因素复杂，本节提供该故障基本的排除方法，如果按照以下操作仍然无法解决该故障，请收集故障处理过程中的信息，联系华为技术支持工程师协助解决。
进行故障修复时，恢复操作系统将会格式化系统分区，请谨慎操作。
管理节点故障排查
重新登录管理面，查看节点的状态。
如果恢复的节点的状态为“正常”，则故障已恢复。
如果恢复的节点的状态为“断连”，请联系华为技术支持工程师。
----结束
产品节点故障
现象描述
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。在左侧导航树中选择“节点监控”，然后在“节点监控”页面左上方选择对应的产品，查看产品下节点的连接状态为“断连”。
可能原因
网络故障。
该节点被下电。
该节点操作系统无法登录或无响应。
处理步骤
对于异地容灾场景，需删除主用站点和备用站点间的异地容灾关系，具体操作请参见《管理员指南》中的“删除异地容灾系统”章节。
依次执行表5-3中的检查项及其检查方法，按照对应的故障排除方法修复故障节点。
导致产品节点故障的因素复杂，本节提供该故障基本的排除方法，如果按照以下操作仍然无法解决该故障，请收集故障处理过程中的信息，联系华为技术支持工程师协助解决。
进行故障修复时，恢复操作系统将会格式化系统分区，请谨慎操作。
产品节点故障排查
重新登录管理面，查看节点的状态。
如果恢复的节点的状态为“正常”，则故障已恢复。
如果恢复的节点的状态为“断连”，请联系华为技术支持工程师。
对于异地容灾场景，需重新建立主用站点和备用站点的异地容灾关系，具体操作请参见《管理员指南》中的“配置异地容灾系统”章节。
----结束
共部署节点故障
现象描述
使用浏览器登录管理面或使用PuTTY工具登录共部署节点时，无法登录或无响应。
可能原因
网络故障。
该节点被下电。
操作系统损坏。
应用程序或数据库损坏。
处理步骤
导致管理节点故障的因素复杂，本节提供该故障基本的排除方法，如果按照以下操作仍然无法解决该故障，请收集故障处理过程中的信息，联系华为技术支持工程师协助解决。
进行故障修复时，恢复操作系统将会格式化系统分区，请谨慎操作。
如果使用共部署节点作为备份服务器，且该节点故障，则管理面不支持修复该节点故障。
依次执行表5-4中的检查项及其检查方法，按照对应的故障排除方法修复故障节点。
产品节点故障排查
尝试使用PuTTY工具以sopuser用户通过SSH方式是否能登录故障节点。
如果正常登录，则说明节点故障已修复，结束本节操作。
如果不能正常登录或无响应，则说明故障节点的操作系统异常，恢复其操作系统，具体操作请参见《管理员指南》中的“恢复管理节点操作系统”章节。
----结束
多个管理节点同时故障（GaussDB）
现象描述
管理面的部署模式是集群模式且使用的数据库为GaussDB，管理面无法正常访问。
可能原因
管理面服务或数据库异常。
多个管理节点同时故障，例如：
Management0节点故障，Management1节点下电。
管理面数据库主备倒换后成为双备状态等。
前提条件
请确保备份服务器下备份文件存在，否则将导致恢复管理面失败。
管理节点的操作系统运行正常。
已获取待恢复管理节点的固定IP地址、ossadm、root和sopuser用户的密码。
已获取备份服务器的端口、IP地址、用户名与密码，并确保备份服务器与待恢复管理节点之间的网络能正常通信。
若系统已使用数据完整性校验密钥的保护密码，确保已获取保护密码。
处理步骤
依次在Management2、Management1、Management0节点上执行步骤1~步骤7。
进行恢复前的准备工作，防止后续步骤中需要查询信息导致恢复操作中断。
防止PuTTY工具超时断连，请设置PuTTY工具在2小时内不断连，具体操作请参见16.1 如何防止PuTTY工具超时断连。
若管理节点和产品节点为同一个节点且使用同一个数据库软件时，确认是否需要恢复数据库软件，具体操作请参见15.25 判断是否恢复数据库软件。
是，则在步骤9的恢复命令中加参数“-restore_type ALL”。
否，则在步骤9的恢复命令中不加参数“-restore_type ALL”。
查看管理面备份文件的版本与当前管理面的版本是否一致，具体操作请参见15.27 查看管理面备份文件及管理面的版本号。
若备份文件的版本与管理面版本一致，执行恢复操作。
若备份文件的版本与管理面版本不一致，此时执行恢复操作，可能导致恢复后节点服务异常，建议获取版本一致的备份文件进行恢复，若没有版本一致的备份文件，请联系华为技术支持工程师处理。
使用PuTTY工具以sopuser通过SSH方式登录所有故障的管理节点，具体操作请参见15.3 使用PuTTY登录服务器。
请勿使用管理节点的浮动IP地址登录节点，须使用固定IP地址登录，否则将导致恢复管理面失败。
执行以下命令，切换到ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令，将备份服务器上的备份文件management.tar.gz、management.tar.gz.sign存放至故障的管理节点的“<临时目录>”目录下。
> cd <临时目录>
> sftp -P 备份服务器端口 备份服务器用户名@[备份服务器IP地址]
系统提示如下信息时，输入备份服务器用户的密码，并按“Enter”。
备份服务器用户名@备份服务器IP地址's password:备份服务器用户的密码 
Connected to 10.10.10.10.
> get 配置备份参数的路径/management/management/时间戳/节点名称/management.tar.gz
> get 配置备份参数的路径/management/management/时间戳/节点名称/management.tar.gz.sign
管理面备份文件及其签名文件的存储路径为：配置备份参数的路径/management/management/时间戳/节点名称，例如：“backup/management/management/20190729002834588/node name”。
系统提示如下类似回显信息，“100%”表示文件传输完成。
Fetching /备份服务器用户根目录/配置备份参数的路径/management/management/时间戳/节点名称/management.tar.gz.sign to management.tar.gz.sign ...100% ...
执行以下命令，退出sftp模式连接备份服务器。
> exit
执行以下命令，修改备份文件的权限。
> chmod 640 <临时目录>/management.tar.gz
> chmod 640 <临时目录>/management.tar.gz.sign
执行以下命令，停止管理面服务和数据库。
> source <安装目录>/manager/bin/engr_profile.sh
> ipmc_adm -cmd stopmgr
系统提示如下类似回显信息，则说明管理面服务和数据库停止成功，请执行步骤7。如果停止失败，执行步骤7。
... 
============================ Stopping management processes is complete. 
... 
============================ Stopping management dc is complete
执行以下操作，进行恢复前预处理。
执行以下命令，切换到root用户。
> su - root
Password:root用户的密码
执行以下命令，查看是否存在“<共享目录>/manager”目录。
# cd <共享目录>/manager
系统回显如下类似信息，表示不存在对应的目录，请执行步骤7.4。
No such file or directory
执行以下命令，将“<共享目录>/manager”目录备份至“<共享目录>/manager-bak”后，再清理“<共享目录>/manager/MCZKService/”目录。
# cp -a <共享目录>/manager <共享目录>/manager-bak
# rm -rf <共享目录>/manager/MCZKService/
执行以下命令，查询是否存在ossadm和dbuser用户启动的进程，存在时清理对应用户进程。
# ps -ef | grep -E '^UID|^ossadm|^dbuser'
系统回显如下类似信息：
UID         PID   PPID  C STIME TTY    TIME ... 
ossadm     5270  35779  0 15:04 ?     00:00:00 ... 
dbuser     5322      1  8 11:36 ?     00:18:26 ... 
...
如果“UID”的值为“ossadm”，表示存在ossadm用户启动的进程，则执行以下命令清理ossadm用户进程。
# ps -fww -uossadm --no-headers |awk '{print $2}'|xargs kill -9
如果“UID”的值为“dbuser”，表示存在dbuser用户启动的进程，则执行以下命令清理dbuser用户进程。
# ps -fww -udbuser --no-headers |awk '{print $2}'|xargs kill -9
如果“UID”的值无“ossadm”和“dbuser”，请跳过此步骤。
执行后使用ps -ef命令再次查询，确保已无ossadm和dbuser用户启动的进程。
执行以下命令，退出root用户。
# exit
执行以下命令，在Management0或Management1节点上查找“mgrdbInstanceName”的主数据库实例所在节点。如果故障节点是Management2节点时，请跳过此步骤。
> cd <临时目录>
> zgrep --binary-files=text 'mgrdbInstanceName=managedbsvr' management.tar.gz
若系统回显如下类似信息，则表示该节点为“mgrdbInstanceName”的主数据库实例所在节点。
mgrdbInstanceName=managedbsvr-0-999
若系统没有回显信息，则表示该节点为“mgrdbInstanceName”的备数据库实例所在节点。
参见表5-5执行相关操作恢复管理面的应用程序和数据。
必须按照先“mgrdbInstanceName”的主数据库实例所在节点，再“mgrdbInstanceName”的备数据库实例所在节点，最后其他节点的顺序分别在节点执行步骤9～步骤10，否则将导致恢复失败。
恢复管理面
系统回显以下信息时，表示管理面恢复成功，且数据库实例和管理面服务也成功启动。
Management restored successfully.
系统回显以下信息时，说明恢复过程中启动管理面服务失败。请先联系华为技术支持工程师，查看管理面数据库实例的状态是否正常。
ERROR: Start management app service failed. 
ERROR: Please check if the dbInstance status is ok, if its not ok, please recovery the dbInstance first, and then try to start management. 
ERROR: Failed to restore management.
管理面数据库实例状态正常，说明管理面服务启动失败并不是由管理面数据库实例状态异常所导致，请联系华为技术支持工程师处理。
管理面数据库实例状态异常，请先修复数据库，具体操作请参见7 数据库故障，并手动启动管理面服务，具体操作请参见15.15 启动管理面服务。
系统回显类似如下信息，说明校验管理面备份文件失败，请联系华为技术支持工程师处理。
ERROR: Verify /opt/backupManagement/management.tar.gz failed. 
ERROR: Failed to restore management.
系统回显类似如下信息时，说明任务执行失败，请联系华为技术支持工程师处理。
ERROR: Failed to restore management.
删除临时目录或文件。
执行以下命令，删除“<临时目录>”目录下的临时文件。
> cd <临时目录>
> rm -f management.tar.gz management.tar.gz.sign
执行以下命令，删除恢复预处理时备份的“manager-bak”目录。若不存在“manager-bak”目录，请跳过此步骤。
> su - root
Password:root用户的密码
> rm -rf <共享目录>/manager-bak
> exit
检查管理面恢复结果。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在监控页面左上方选择CloudSOP-UniEP。
分别在“节点监控”、“服务监控”、“中间件监控”页面查看服务和数据库实例的运行状态。
节点状态为“连接”、服务和数据库实例状态均为“正在运行”，则管理面恢复成功，否则请联系华为技术支持工程师处理。
检查产品的状态是否正常。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在“中间件监控”页面左上方选择对应的产品。
在“关系数据库”或“Redis数据库”页签中检查产品数据库实例的“状态”是否均为“正在运行”。
是，则说明管理面恢复成功，且产品业务正常。
否，请先修复数据库，具体操作请参见7 数据库故障。若管理节点和产品节点为同一个节点，则还需恢复产品的应用程序和产品数据，须严格按照恢复产品应用程序、恢复产品数据的顺序依次执行且无需重复执行产品数据的恢复，具体操作请参见《管理员指南》中“恢复产品应用程序”和“恢复产品数据”章节。判断管理节点和产品节点是否为同一个节点，具体操作请参见15.12 查看节点的部署模式。
----结束
浮动IP地址倒换生效时间超出预期
现象描述
浮动IP地址发生倒换时，倒换生效时间超出预期。
可能原因
浮动IP地址发生倒换迁移时，若网关支持BRAS(broadband remote access server)认证，浮动IP地址的迁移不会立即生效，只有BRAS路由表老化时或者BRAS检测到原主节点失效才会生效，浮动IP地址倒换时间以路由表老化时间或者BRAS检测时间为准。
处理步骤
联系管理员确认BRAS路由表老化时间和检测时间，经过该时间后查看倒换是否成功，若倒换仍未生效，请联系华为技术支持工程师。
部分产品节点下电导致kafka服务异常
现象描述
ZookeeperService服务部署在多个产品节点上时，当对其中过半的产品节点下电后，其他未下电的ZookeeperService服务所在产品节点的状态异常，ZookeeperService服务影响kafka服务的正常运行，从而导致其他服务通过kafka服务收发消息的功能异常。
可能原因
由于ZookeeperService服务自身机制要求，需要确保部署了ZookeeperService服务的一半以上节点处于“正在运行”状态，kafka服务依赖于ZookeeperService服务，当ZookeeperService服务异常时，kafka服务势必也出现异常。
处理步骤
对已下电的ZookeeperService服务所在产品节点进行上电操作。
登录管理面，具体操作请参见15.1 登录管理面。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在左侧导航树中选择“节点监控”。
在“节点监控”页面左上方选择对应的产品。
在“节点监控”页面左上方，单击“停止”，在下拉框中选择“停止服务”，按照界面指引完成相关操作。
待产品的所有服务停止成功后，“节点列表”中节点的“服务状态”显示为“未运行”。
在“节点监控”页面左上方，单击“启动”，在下拉框中选择“启动服务”，按照界面指引完成相关操作。
待产品的所有服务启动成功后，“节点列表”中节点的“服务状态”显示为“正在运行”。
----结束
操作系统故障
6.1  系统时间与NTP时间不一致
6.2  NTP服务器状态异常
6.3  日志损坏导致HIROIRService/HIROERService/HIROBERService启动失败
系统时间与NTP时间不一致
现象描述
服务器操作系统时间与NTP（Network Time Protocol）时钟源的时间不一致，无法从NTP时钟源同步时间。
在管理面主菜单中选择“维护 > 时间管理 > 配置NTP”，在“配置NTP”页面中，NTP服务器的时间同步状态为“失效”。
如果管理面的部署模式是集群模式，登录管理面成功后，客户端会话自动注销。
可能原因
网络故障。
NTP时钟源的时间发生跳变。
前提条件
已获取待修改时间节点的sopuser、ossadm和root用户的密码。
已获取主用NTP时钟源的IP地址。
对于异地容灾场景，需删除主用站点和备用站点间的异地容灾关系，具体操作请参见《管理员指南》中的“删除异地容灾系统”章节。
操作须知
时间同步过程中需要重启待修改时间节点的产品服务和数据库，请在业务量低的时期执行以下操作。
处理步骤
强制同步时区时间的方法分为界面方式和手工方式两种，使用界面方式执行强制同步的操作后，系统会缓慢调整同步时间，不会发生时间跳变；使用手工方式执行强制同步操作后，系统立即强制同步时间，会发生时间跳变，时间跳变对时间要求较高的功能会造成影响（如：备份恢复功能）。请根据实际情况选择适合的方式进行时区时间的同步方式。
界面方式
登录管理面，具体操作请参见15.1 登录管理面。
在管理面主菜单中选择“维护 > 时间管理 > 配置时区时间”。
在“配置时区时间”界面，单击“强制同步”。
如果强制同步时区时间后，还需要做其他需要重启产品服务或产品数据库的配置操作，请取消选中“警告”对话框中的“强制同步时区时间完成后自动启动产品数据库和产品服务”，则强制同步完成后不会自动启动产品数据库和产品服务，避免产品服务或产品数据库被多次重启。
对于异地容灾场景，如果强制同步的时区时间是备用站点的时区时间，请取消选中“警告”对话框中“强制同步时区时间完成后自动启动产品数据库和产品服务”，避免备用站点上的产品服务被重启，造成双主运行的异常状态。
如果强制同步时区时间后，同步后和同步前的时间差，超出会话自动注销等待时间，客户端会话会自动注销。
在主菜单选择“系统 > 任务列表”，等待（大约1～15分钟）“强制同步时区时间”任务执行成功。
查看服务器操作系统时间与NTP时钟源的时间是否精确一致。
是，则故障已恢复。
否，请联系华为技术支持工程师定位处理。
对于异地容灾场景，故障修复后需建立主用站点和备用站点的异地容灾关系，具体操作请参见《管理员指南》中的“配置异地容灾系统”章节。
手工方式
对于Euler操作系统：
使用PuTTY工具以sopuser用户通过SSH方式登录待修改时间节点。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，切换到ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令停止该节点的服务。
> source <安装目录>/manager/bin/engr_profile.sh
> ipmc_adm -cmd stopnode
当管理面应用程序和数据处于故障，未恢复状态时，请跳过此步骤。
系统提示如下类似回显信息，所有进程都提示“success”，则说明该节点所有服务停止成功，否则请联系华为技术支持工程师。
... 
Stopping process mcdrrouteragent-1-0 ... success 
Stopping process testdummyagent-1-0 ... success 
Stopping process uniepservice-1-0 ... success 
...
执行以下命令，判断NTP服务使用的组件。
若待修改时间节点为管理节点，执行如下命令。
> cat <安装目录>/manager/var/etc/common/custom.cfg | grep MGMT_NTP_TYPE
若如下类似回显信息，则表示NTP服务使用的是ntpd组件。若无回显内容，需要参考下方场景的操作执行。
MGMT_NTP_TYPE=ntpd
当管理面的部署模式是集群模式时，只需要在Management0和Management1节点分别执行上述命令。
若待修改时间节点为产品节点或Management0、Management1之外的管理节点，执行如下命令。
> bash <系统应用程序目录>/local/osconfig/os/bin/getsupportntptype.sh
若如下类似回显信息，则表示操作系统支持ntpd组件，NTP服务使用的是ntpd组件。
["ntpd"]
若如下类似回显信息，则表示操作系统支持chrony组件，NTP服务使用的是chrony组件。
["chrony"]
若如下类似回显信息，则表示操作系统支持ntpd和chrony组件，NTP服务默认优先使用chrony组件。
["ntpd", "chrony"]
执行以下命令，切换到root用户。
> su - root
Password:root用户的密码
根据iv查询的组件类型选择的对应的操作，停止待修改时间节点的NTP服务。
ntpd组件
# service ntpd stop
chrony组件
# systemctl stop chronyd
执行以下命令，从NTP时钟源同步系统时间。
# ntpdate 时钟源IP地址
# timedatectl set-local-rtc 0
# hwclock --systohc -u
# echo $?
当回显为0表示从NTP时钟源同步系统时间成功。否则，联系华为技术支持工程师。
0
命令中的“时钟源IP地址”请替换为实际规划的IP地址，若待修改时间的服务器为管理节点，则替换为NTP时钟源的IP地址；若为产品节点，则替换为Management0节点的IP地址。
执行以下命令，退出root用户。
# exit
执行以下命令，查看当前服务器的时间，并查看是否与NTP时钟源的时间精确一致。
> date
系统回显如下类似信息：
Tue May 26 19:46:12 CST 2019
若待修改时间的为管理节点，则节点的时间需与NTP时钟源时间精确一致。
若待修改时间的为产品节点，则节点的时间需与管理节点的时间精确一致。
如果时间精确一致，执行x和xi，否则请联系华为技术支持工程师。
执行以下命令，切换到root用户。
> su - root
Password:root用户的密码
根据iv查询的组件类型选择的对应的操作，启动待修改节点的NTP服务。
ntpd组件
# service ntpd start
chrony组件
# systemctl start chronyd
执行以下命令，退出root用户。
# exit
执行以下命令，启动节点上的服务。
> source <安装目录>/manager/bin/engr_profile.sh
> ipmc_adm -cmd startnode
当管理面应用程序和数据处于故障，未恢复状态时，请跳过此步骤。
系统提示如下类似回显信息，所有进程都提示“success”，则说明该节点所有服务启动成功，否则请联系华为技术支持工程师。
... 
Starting process testdummyagent-1-0 ... success 
Starting process mcdrrouteragent-1-0 ... success 
Starting process mcir-1-0 ... success 
...
对于异地容灾场景，故障修复后需建立主用站点和备用站点的异地容灾关系，具体操作请参见《管理员指南》中的“配置异地容灾系统”章节。
NTP服务器状态异常
现象描述
在管理面主菜单中选择“维护 > 时间管理 > 配置NTP”，在“配置NTP”页面，添加完NTP服务器后，在NTP服务器列表中，检查NTP服务器的时间同步状态为“失效”。
可能原因
网络故障。
NTP服务器和管理节点之间的时间同步关系异常。
前提条件
已获取管理节点的sopuser、ossadm和root用户的密码。
对于异地容灾场景，需删除主用站点和备用站点间的异地容灾关系，具体操作请参见《管理员指南》中的“删除异地容灾系统”章节。
处理步骤
检查管理节点与上级NTP服务器间的网络连接是否正常。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，请分别登录Management0和Management1节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，切换到ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令，判断NTP服务使用的组件。
若节点为管理节点，执行如下命令。
> cat <安装目录>/manager/var/etc/common/custom.cfg | grep MGMT_NTP_TYPE
若如下类似回显信息，则表示NTP服务使用的是ntpd组件。若无回显内容，需要参考下方场景的操作执行。
MGMT_NTP_TYPE=ntpd
当管理面的部署模式是集群模式时，只需要在Management0和Management1节点分别执行上述命令。
若节点为产品节点或Management0、Management1之外的管理节点，执行如下命令。
> bash <系统应用程序目录>/local/osconfig/os/bin/getsupportntptype.sh
若如下类似回显信息，则表示操作系统支持ntpd组件，NTP服务使用的是ntpd组件。
["ntpd"]
若如下类似回显信息，则表示操作系统支持chrony组件，NTP服务使用的是chrony组件。
["chrony"]
若如下类似回显信息，则表示操作系统支持ntpd和chrony组件，NTP服务默认优先使用chrony组件。
["ntpd", "chrony"]
根据步骤1.3查询的组件类型选择的对应的操作，检查管理节点与上级NTP服务器间的网络连接是否正常。
ntpd组件
> ntpq -np
remote           refid      st t when poll reach   delay   offset  jitter 
============================================================================== 
* x.x.x.x         LOCAL(0)      6 u   90  128  377    0.199   -0.024   0.043
若系统回显信息中“reach”、“delay”、“offset”和“jitter”的值均不为0，代表管理节点与上级NTP服务器间的网络连接正常。
若系统回显信息中“reach”、“delay”、“offset”和“jitter”的值均为0，代表管理节点与上级NTP服务器间的网络连接异常。
chrony组件
> chronyc -n sources
M S  Name/IP address         Stratum Poll Reach LastRx Last sample 
=============================================================================== 
^ ?  x.x.x.x                 0  10     0     -     +0ns[   +0ns] +/-    0ns
若系统回显信息中“S”的值为“*”，代表管理节点与上级NTP服务器间的网络连接正常。
若系统回显信息中“S”的值为“?”，代表管理节点与上级NTP服务器间的网络连接异常。
检查上级NTP服务器的NTP服务是否正常。
联系NTP端工程师，确认NTP服务器的NTP服务状态，确保NTP服务已启动且已为管理面提供NTP服务。
检查管理节点的NTP服务是否正常。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，请分别登录Management0和Management1节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，切换到ossadm用户。
> su - ossadm
Password:ossadm用户的密码
根据步骤1.3查询的组件类型选择的对应的操作，检查是否存在运行的NTP服务。
ntpd组件
> service ntpd status
若系统回显信息中包含“active (running)”字样的信息，说明节点的NTP服务已启动。
否则，说明节点的NTP服务未启动，执行步骤3.4启动NTP服务。
chrony组件
> systemctl status chronyd
若系统回显信息中包含“active (running)”字样的信息，说明节点的NTP服务已启动。
否则，说明节点的NTP服务未启动，执行步骤3.4启动NTP服务。
执行以下命令，切换至root用户。
> su - root
Password:root用户的密码
执行以下命令，启动NTP服务。
ntpd组件
# service ntpd start
chrony组件
# systemctl start chronyd
执行以下命令，退出root用户。
# exit
如果以上检查结果都正常但NTP服务器的时间同步状态仍处于“失效”状态，请继续执行以下操作：
登录管理面，具体操作请参见15.1 登录管理面。
在管理面主菜单中选择“维护 > 时间管理 > 配置NTP”，在“配置NTP”界面单击“重新配置”。
弹出“确认”对话框，单击“是”。
在管理面主菜单中选择“维护 > 时间管理 > 配置时区时间”，在“配置时区时间”界面，单击“强制同步”。
如果强制同步时区时间后，还需要做其他需要重启产品服务或产品数据库的配置操作，请取消选中“警告”对话框中的“强制同步时区时间完成后自动启动产品数据库和产品服务”，则强制同步完成后不会自动启动产品数据库和产品服务，避免产品服务或产品数据库被多次重启。
对于异地容灾场景，如果强制同步的时区时间是备用站点的时区时间，请取消选中“警告”对话框中“强制同步时区时间完成后自动启动产品数据库和产品服务”，避免备用站点上的产品服务被重启，造成双主运行的异常状态。
如果强制同步时区时间后，同步后和同步前的时间差超出会话自动注销等待时间，客户端会话会自动注销。
在主菜单选择“系统 > 任务列表”，等待“强制同步时区时间”任务执行成功。
任务执行完成后，若NTP服务器的时间同步状态仍为“失效”，执行以下操作。
若步骤1.3查询的组件为chrony组件，则执行步骤4.6.b，若为ntpd组件请联系华为技术支持工程师定位处理。
在管理面主菜单中选择“维护 > 时间管理 > 配置NTP”。
当加密方式选择“NTP v4认证”时，在“配置NTP”界面修改该NTP服务器的“Key值”，结合界面上该值的配置规则根据实际情况修改。
执行步骤4.4～步骤4.5强制同步时区时间。
对于异地容灾场景，修复故障后需建立主用站点和备用站点的异地容灾关系，具体操作请参见《管理员指南》中的“配置异地容灾系统”章节。
----结束
日志损坏导致HIROIRService/HIROERService/HIROBERService启动失败
现象描述
HIROIRService/HIROERService/HIROBERService启动失败，查看HIROERService/HIROIRService/HIROBERService的日志属主权限的属性变为“？？？？”，表明日志文件损坏。
如<日志目录>/<产品名称>/HIROERService目录下HIROERService日志属主权限的属性变为“？？？？”。
????????? ? ?       ?              ?           ? oss.bus_adm.script.trace 
rw-------.1 ossuser ossgroup    1380 Jan 3 16:22 oss.busdeploy.trace
可能原因
磁盘空间满导致日志文件损坏，导致HIROIRService/HIROERService/HIROBERService启动失败。
处理步骤
由于日志损坏导致HIROIRService/HIROERService/HIROBERService启动失败的处理方法相同，这里以HIROERService举例进行说明。
使用PuTTY工具以sopuser用户通过SSH方式登录hiroer进程实例所在节点。获取进程所在节点的IP地址的方法请参见15.7 查找进程或服务所在节点的管理IP地址。
执行以下命令切换到root用户。
su - root
Password:root用户的密码
执行以下命令，复制日志文件夹。
cd <日志目录>/<产品名称>
cp -r HIROERService HIROERService1
cp命令只会将所有未损坏的文件复制到新文件夹HIROERService1中。
执行以下命令移走原文件夹。
mv HIROERService HIROERService_bak
执行以下命令将文件夹HIROERService1移回原文件夹。
mv HIROERService1 HIROERService
执行以下命令修改HIROERService文件夹的属主属性。
chown -R ossuser:ossgroup HIROERService
执行以下命令删除HIROERService_bak文件。
执行以下命令，查看HIROERService_bak下文件的属主权限。
cd <日志目录>/<产品名称>/HIROERService_bak
ll
查看是否存在文件的属主权限变为“？？？？”。
是，执行步骤7.2。
否，执行步骤7.3。
执行以下命令，移动属主权限为“？？？？”的文件目录到其他位置。以HIROERService_bak下的HIROERService目录为例。
mv <日志目录>/<产品名称>/HIROERService_bak/HIROERService <临时目录>/HIROERService
执行以下命令，删除HIROERService_bak下的文件。
cd <日志目录>/<产品名称>
rm -rf HIROERService_bak/*
执行以下命令，退出root用户。
exit
----结束
数据库故障
介绍GaussDB数据库实例、Redis数据库实例异常的修复方法。其他类型数据库实例异常的修复请联系华为技术支持工程师。
操作须知
当数据库实例出现异常时，请先修复该数据库实例异常。如果由于故障叠加造成的数据库多实例的故障，可能会导致数据库实例出现双主，当一个数据库实例降备后，主备数据库实例数据自动同步导致数据丢失。
7.1  产品数据库实例异常
7.2  系统重启后主数据库实例运行状态异常
7.3  主数据库实例异常且备数据库实例无法自动升主
7.4  管理面或产品数据库实例复制状态异常
产品数据库实例异常
现象描述
在“全景监控”中，“关系数据库”或“Redis数据库”页签的数据库实例“状态”为“未运行”或“未知”。
可能原因
数据库实例所在节点可能被停止。
数据库实例被人为停止。
数据库进程异常后重启失败。
数据库文件损坏。
误删除操作系统数据库文件。
处理步骤
联系管理员检查数据库实例所在虚拟机或物理机是否停止。
是，请启动虚拟机或物理机，并查看故障是否已恢复。
若故障已恢复则操作结束，否则执行步骤2。
否，执行步骤2。
检查节点是否故障，具体操作请参见5 节点故障。
是，请参见5 节点故障章节修复节点故障。
否，执行步骤3。
检查数据库实例的“状态”。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在左侧导航树中选择“中间件监控”。
在“中间件监控”页面左上方选择对应的产品。
查看数据库实例运行状态。
在“关系数据库”或“Redis数据库”页签中检查数据库实例的“状态”是否为“未运行”或“未知”。
是，请参见15.17 启动产品数据库手工启动数据库实例所在节点。
启动成功，数据库实例的状态为“正在运行”，则故障已恢复。
如数据库实例是人为停止，请排查人为停止原因，在其任务完成后启动。
启动失败，数据库实例状态仍为“未运行”或“未知”，则执行步骤4。
否，则执行步骤4。
恢复数据库应用程序，具体操作请参见《管理员指南》中的“恢复数据库应用程序”章节。
登录管理面查看数据库实例是否恢复正常。
如果数据库实例的状态恢复正常，则故障已恢复。
如果数据库实例的状态未恢复正常，请联系华为技术支持工程师。
----结束
系统重启后主数据库实例运行状态异常
现象描述
系统重启（CloudSOP的所有节点重启）后，在“关系数据库”或“Redis数据库”页签中主数据库实例的“状态”为“未运行”或“未知”，“复制状态”为“异常”。
可能原因
主数据库实例所在节点异常下电导致主数据库实例文件损坏或操作系统损坏，从而使主数据库实例所在节点无法启动。
处理步骤
使用PuTTY工具以sopuser用户通过SSH方式登录故障数据库实例所在节点，获取数据库实例所在节点的IP地址请参见15.8 查找数据库实例所在节点的管理IP地址。
执行以下命令，切换至root用户。
su - root
Password:root用户的密码
执行如下命令，创建临时目录。
如下操作命令以目录“log_info”为例，请根据实际情况替换。
mkdir <临时目录>/log_info
执行如下命令，将日志文件复制至该目录并设置权限和属组。
cp -r /opt/zenith/data/数据库实例名称/log <临时目录>/log_info
chmod -R 750 <临时目录>/log_info
chgrp -R sopgroup <临时目录>/log_info
执行如下命令，退出至sopuser用户。
exit
使用FileZilla工具以sopuser用户通过SFTP方式将“<临时目录>/log_info”目录下的操作系统日志文件下载至本地PC的任意路径，具体操作请参见15.4 使用FileZilla传输文件。
日志下载成功后，需清理临时目录。
使用PuTTY工具以sopuser用户执行如下命令切换至root用户。
su - root
Password:root用户的密码
执行如下命令，清理“<临时目录> /log_info”目录。
cd <临时目录>
rm -rf log_info
执行如下命令，退出至sopuser用户。
exit
联系华为技术支持工程师根据日志文件修复主数据库实例故障。
已修复，操作完成。
未修复，执行步骤9。
执行如下操作，进行主备数据库实例倒换。
数据库实例倒换可能会存在数据丢失风险。由于重启数据库之前，无法确定主备数据库实例所在节点的数据是否完全同步。请尽量在业务量少的情况下进行主备数据库实例倒换，以减少影响。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，需在Management0或Management1的其中任一节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行如下命令，切换到ossadm用户。
su - ossadm
Password:ossadm用户的密码
执行如下命令，查询数据库实例ID和备数据库实例名称。
cd <安装目录>/manager/apps/DBAgent/bin
./dbsvc_adm -cmd query-db-instance
系统提示类似如下回显信息：
DBInstanceId             ClassId  InstNumber         Tenant   AzName         IP              Port   State  DBType  Version            Role    RplStatus  MasterID           GuardMode  DataCheckSum  isSSL  RplPort 
managedbsvr-0-999@1-999  primary  managedbsvr-0-999  manager  cn-global-1-a  10.120.243.233  32080  Up     gauss   V100R003C20CP1152  Master  Normal      --                 --         962349459     on     26950 
managedbsvr-0-999@1-999  primary  managedbsvr-1-999  manager  cn-global-1-a  10.120.243.123  32080  Up     gauss   V100R003C20CP1152  Slave   Normal      managedbsvr-0-999  --         962349459     on     26950
待升主的备数据库实例名称可以从“InstNumber”列获取，例如“managedbsvr-0-999”。
数据库实例ID可以“DBInstanceId”列获取，例如“managedbsvr-0-999@1-999”。
执行如下命令，进行数据库实例倒换。
cd <安装目录>/manager/apps/CloudbMgmtService/bin
./switchtool.sh -cmd switchover -instid 数据库实例ID -newmaster 待升主的备数据库实例名称
数据库实例ID和备数据库实例名称从步骤9.3获取。
验证主备数据库实例倒换结果。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在左侧导航树中选择“中间件监控”。
在“中间件监控”页面左上方选择对应的产品，在“关系数据库”或“Redis数据库”页签中查看，原备数据库实例的“角色”由“Slave”变成“Master”，且“状态”为“正在运行”，数据库的“复制状态”为“正常”，表示主备数据库实例倒换成功。
如果操作结果与预期不符，请联系华为技术支持工程师。
----结束
主数据库实例异常且备数据库实例无法自动升主
现象描述
在“全景监控”中，“关系数据库”或“Redis数据库”页签的主数据库实例“状态”为“未运行”或“未知”，备数据库实例的“状态”为“正常”，且长时间内备数据库实例无法自动升主。
可能原因
数据库被禁止倒换场景如下：
数据库升级。
节点启停。
产品定制禁止倒换。
在主数据库实例异常前，主备数据不同步场景如下：
主备数据差异过大，数据延迟。
主备数据库实例之间复制链路断开。
处理步骤
联系管理员检查数据库实例所在虚拟机或物理机是否停止。
是，请启动虚拟机或物理机，并查看故障是否已恢复。
若故障已恢复则操作结束，否则执行步骤2。
否，执行步骤2。
检查节点是否故障，具体操作请参见5 节点故障。
是，请参见5 节点故障章节修复节点故障。
否，执行步骤3。
检查数据库实例的“状态”。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在左侧导航树中选择“中间件监控”。
在“中间件监控”页面左上方选择对应的产品。
查看数据库实例运行状态。
在“关系数据库”或“Redis数据库”页签中检查数据库实例的“状态”是否为“未运行”或“未知”。
是，请参见15.17 启动产品数据库手工启动数据库实例所在节点。
启动成功，数据库实例的状态为“正在运行”，则故障已恢复。
如数据库实例是人为停止，请排查人为停止原因，在其任务完成后启动。
启动失败，数据库实例状态仍为“未运行”或“未知”，则执行步骤4。
否，则执行步骤4。
恢复数据库应用程序，具体操作请参见《管理员指南》中的“恢复数据库应用程序”章节。
登录管理面查看数据库实例是否恢复正常。
如果数据库实例的状态恢复正常，则故障已恢复。
如果数据库实例的状态未恢复正常，请联系华为技术支持工程师。
----结束
管理面或产品数据库实例复制状态异常
现象描述
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。在左侧导航树中选择“中间件监控”，在“中间件监控”页面左上方选择对应的产品或CloudSOP-UniEP，在页面的“关系数据库”页签下数据库实例的“状态”为“正在运行”，“复制状态”为“异常”，等待一段时间后复制状态仍未恢复正常。
可能原因
网络延迟。
主数据库写操作超负荷。
TPS（系统吞吐量）高或者有大事务超过了备数据库的复制处理能力。
备数据库实例所在的服务器的硬件配置过低。
前提条件
已获取管理节点sopuser和ossadm用户的密码。
处理步骤
查询“复制状态”为“异常”的数据库实例所对应的“实例名称”。
在管理面主菜单中选择“维护 > 运维管理 > 全景监控”。
在左侧导航树中选择“中间件监控”。
在“中间件监控”页面左上方选择对应的产品或CloudSOP-UniEP。
选择“关系数据库”页签，查看并记录“复制状态”为“异常”的数据库实例对应的“实例名称”。
使用PuTTY工具以sopuser用户通过SSH方式登录管理节点。
如果管理面的部署模式是集群模式，即存在多个管理节点，需在Management0或Management1的其中任一节点执行以下操作。获取节点IP地址的方法请参见15.6 查找节点对应的管理IP地址。
执行以下命令，切换至ossadm用户。
> su - ossadm
Password:ossadm用户的密码
执行以下命令，查看“复制状态”为“异常”的数据库实例名称所对应的状态。
> cd <安装目录>/manager/apps/DBAgent/bin
> bash dbsvc_adm -cmd query-db-instance
系统提示如下类似回显信息：
DBInstanceId                ... IP           Port   ... Role    Rpl Status     ... 
catalogrdb-8-24@9-24        ... xx.xx.xx.xx  26532  ... Master  Normal         ... 
catalogrdb-8-24@9-24        ... xx.xx.xx.xx  26532  ... Slave   Delay (301)    ... 
cloudsopapidbsvr-2-2@7-2    ... xx.xx.xx.xx  32082  ... Master  Normal         ... 
cloudsopapidbsvr-2-2@7-2    ... xx.xx.xx.xx  32082  ... Slave   Normal         ... 
cloudsopdbsvr-0-1000@1-1000 ... xx.xx.xx.xx  32081  ... Master  Normal         ... 
cloudsopdbsvr-0-1000@1-1000 ... xx.xx.xx.xx  32081  ... Slave   Abnormal (101) ... 
...
如果“Rpl Status”的值为“Normal”，表示该数据库实例复制状态正常。说明管理面或产品数据库实例复制状态异常是由于其他原因导致，请联系华为技术支持工程师。
如果“Rpl Status”的值为“Delay”，表示备数据库正在同步主数据库上的数据，等待一段时间后，该值将恢复为“Normal”。
如果“Rpl Status”的值为“Abnormal”，表示数据库实例复制状态异常，请联系华为技术支持工程师。
----结束
